# Анализ временного ряда на основе транзакционных данных онлайн-розничной торговли

## Описание проекта
Этот проект посвящен анализу временного ряда на основе транзакционных данных онлайн-розничной торговли. Данные охватывают период с 01/12/2010 по 09/12/2011 и включают все транзакции, произошедшие в этот период для не-магазинного онлайн-розничного продавца, зарегистрированного в Великобритании. Компания в основном продает уникальные подарки для всех случаев. Многие клиенты компании являются оптовиками.

## Датасет
Датасет был взят с сайта [UCI Machine Learning Repository](https://archive.ics.uci.edu/dataset/352/online+retail).

### Описание колонок
| Название колонки | Роль      | Тип         | Описание                                                                                    | Единицы измерения | Пропущенные значения |
|------------------|-----------|-------------|---------------------------------------------------------------------------------------------|-------------------|----------------------|
| `InvoiceNo`      | ID        | Categorical | Номер счета-фактуры. Уникальный шестизначный целый номер, присваиваемый каждой транзакции. Если код начинается с буквы 'c', это означает отмену. | нет               | нет                  |
| `StockCode`      | ID        | Categorical | Код продукта. Уникальный пятизначный целый номер, присваиваемый каждому отдельному продукту. | нет               | нет                  |
| `Description`    | Feature   | Categorical | Наименование продукта.                                                                      | нет               | нет                  |
| `Quantity`       | Feature   | Integer     | Количество каждого продукта (товара) за транзакцию.                                         | нет               | нет                  |
| `InvoiceDate`    | Feature   | Date        | День и время, когда была создана транзакция.                                                | нет               | нет                  |
| `UnitPrice`      | Feature   | Continuous  | Цена продукта за единицу.                                                                   | фунт стерлингов   | нет                  |
| `CustomerID`     | Feature   | Categorical | Уникальный пятизначный целый номер, присваиваемый каждому клиенту.                          | нет               | нет                  |
| `Country`        | Feature   | Categorical | Название страны, где проживает каждый клиент.                                               | нет               | нет                  |

## Структура проекта
Проект имеет следующую структуру:

<pre>
HW_6/
├── Data/
│   └── online+retail.zip
├── Modules/
│   ├── <a href="#data_loaderpy">data_loader.py</a>
│   ├── <a href="#edapy">eda.py</a>
│   ├── <a href="#feature_engineeringpy">feature_engineering.py</a>
│   ├── <a href="#modelingpy">modeling.py</a>
│   ├── <a href="#preprocessingpy">preprocessing.py</a>
│   └── <a href="#visualizationpy">visualization.py</a>
├── <a href="#main.ipynb">main.ipynb</a>
├── README.md
└── <a href="#requirementstxt">requirements.txt</a>
</pre>

## Описание корневых файлов

### `main.ipynb`
[Открыть main.ipynb на GitHub](https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/main.ipynb)

Файл Jupyter Notebook, содержащий основной код проекта. Включает в себя все этапы анализа данных, от предварительной обработки до моделирования. Запустите основной файл для выполнения проекта.

### `requirements.txt`
[Открыть requirements.txt на GitHub](https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/requirements.txt)

Файл `requirements.txt` содержит список всех зависимостей и библиотек, необходимых для выполнения проекта. Убедитесь, что все библиотеки установлены, прежде чем запускать проект.

## Описание модулей

### `data_loader.py`
<sup>[Открыть data_loader.py на GitHub](https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/Modules/data_loader.py)</sup>

Модуль для загрузки данных из различных источников.

- `load_data_from_site()`: Загрузка датасета 'Online Retail' из репозитория UCI и сохранение в файл. Если файл уже существует, данные загружаются из него. Возвращает DataFrame с данными.
- `load_data_from_zip()`: Загрузка датасета 'Online Retail' из zip-архива и сохранение в файл. Если файл CSV уже существует, данные загружаются из него. В противном случае данные извлекаются из zip-архива, загружаются из Excel файла и сохраняются в CSV для ускорения будущих загрузок. Возвращает DataFrame с данными.
- `data_load()`: Запрос у пользователя о выборе источника данных (с сайта или из архива) и загрузка данных из соответствующего источника. Если выбор пользователя некорректен, используется загрузка из архива по умолчанию. Возвращает DataFrame с данными.

#### Опциональные файлы, создаваемые в подкаталоге Data

- `label_encodings.txt`: Файл содержит закодированные метки для категориальных переменных. Используется для преобразования категориальных данных в числовые значения.
- `online_retail_csv.csv`: CSV файл, содержащий данные датасета 'Online Retail', извлеченные из Excel файла и сохраненные для ускорения будущих загрузок.
- `online_retail_features.csv`: CSV файл, содержащий признаки (features) данных, загруженных из репозитория UCI.
- `Online Retail.xlsx`: Excel файл, содержащий полный датасет 'Online Retail', извлеченный из zip-архива.

Эти файлы являются опциональными и создаются при выполнении модуля `data_loader.py`.

### `eda.py`
<sup>[Открыть eda.py на GitHub](https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/Modules/eda.py)</sup>

Модуль для выполнения анализа данных (EDA).

- `perform_eda(df)`: Выполняет анализ данных (EDA) для переданного DataFrame. Включает:
  - Вывод информации о полях и типах данных.
  - Отображение первых строк данных.
  - Статистический срез данных.
  - Проверка пропущенных значений.
  - Дополнительный анализ, включающий количество уникальных значений, количество заказов и возвратов, временной интервал данных.
- `compare_statistics(df1, df2)`: Сравнение статистических срезов двух DataFrame и вывод краткого заключения. Функция определяет значительные различия в среднем значении и стандартном отклонении между двумя датасетами.
- `print_comparison_results(df1, df2)`: Печать результатов сравнения статистических срезов двух DataFrame. Выводит, на какие показатели серьезно повлияли пропуски данных.
- `analyze_missing_values(df)`: Анализ данных с пропущенными значениями и без них, сравнение статистических срезов. Функция выполняет EDA для данных без пропусков и сравнивает их с полным датасетом.
- `analyze_returns(df)`: Анализ доли возвратов в датасете, подсчет количества и суммы возвратов и продаж. Функция делит данные на возвраты и продажи, вычисляет количество и суммы возвратов и продаж, а также процент возвратов по количеству и сумме.

### `feature_engineering.py`
<sup>[Открыть feature_engineering.py на GitHub](https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/Modules/feature_engineering.py)</sup>

Модуль для создания новых признаков на основе исходных данных.

- `calculate_amount(df)`: Рассчитывает столбец 'Amount' как произведение 'Quantity' и 'UnitPrice'.
- `create_invoice_features(df)`: Создает фичи для каждого чека на основе группировки по `InvoiceNo`. Включает:
  - `TotalAmount`: Общая сумма за чек.
  - `MinUnitPrice`: Минимальная цена за единицу товара в чеке.
  - `MaxUnitPrice`: Максимальная цена за единицу товара в чеке.
  - `MedianUnitPrice`: Медианная цена за единицу товара в чеке.
  - `MinQuantity`: Минимальное количество товара в чеке.
  - `MaxQuantity`: Максимальное количество товара в чеке.
  - `TotalQuantity`: Общее количество товара в чеке.
  - `InvoiceDate`: Дата чека.
  - `CustomerID`: Идентификатор клиента.
- `create_customer_features(df)`: Создает фичи для каждого клиента на основе группировки по `CustomerID`. Включает:
  - `FirstPurchaseDate`: Дата первой покупки.
  - `LastPurchaseDate`: Дата последней покупки.
  - `TotalPurchaseCount`: Общее количество покупок.
  - `TotalPurchaseAmount`: Общая сумма покупок.
  - `AveragePurchaseAmount`: Средняя сумма покупок.
  - `TotalQuantity`: Общее количество купленного товара.
  - `DaysSinceFirstPurchase`: Количество дней с момента первой покупки.
  - `LastMonthPurchaseAmount`: Сумма покупок за последний месяц.
- `create_date_features(df)`: Создает фичи на основе группировки по дате (без времени). Включает:
  - `Date`: Дата (без времени).
  - `TotalSalesAmount`: Общая сумма продаж за день.
  - `TotalSalesQuantity`: Общее количество товаров, проданных за день.
  - `AverageSalesAmount`: Средняя сумма продаж за день.
  - `AverageSalesQuantity`: Среднее количество товаров, проданных за день.
  - `NumberOfTransactions`: Количество транзакций за день.
  - `DayOfWeek`: День недели (0 = понедельник, 1 = вторник и т.д.).
  - `WeekOfYear`: Номер недели в году.
  - `MonthOfYear`: Месяц года.

### `modeling.py`

Модуль для обучения и прогнозирования моделей временного ряда.

- `arima_model(train_data, test_data, order)`: Обучает модель ARIMA на тренировочных данных с заданными параметрами `order` и возвращает прогноз на тестовых данных.
- `auto_arima_model(train_data, test_data)`: Обучает модель ARIMA с автоматическим подбором параметров и возвращает прогноз на тестовых данных.
- `sarima_model(train_data, test_data)`: Обучает модель SARIMA на тренировочных данных с автоматическим подбором параметров и возвращает прогноз на тестовых данных.
- `lstm_model(train_data, test_data, seq_length, epochs, batch_size)`: Обучает LSTM модель на тренировочных данных и возвращает прогноз на тестовых данных.
- `cnn_model(train_data, test_data, seq_length, epochs)`: Обучает модель CNN на тренировочных данных и возвращает прогноз на тестовых данных.
- `gru_model(train_data, test_data, seq_length, epochs, batch_size)`: Обучает модель GRU на тренировочных данных и возвращает прогноз на тестовых данных.

### `preprocessing.py`
<sup>[Открыть preprocessing.py на GitHub](https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/Modules/preprocessing.py)</sup>

Модуль для предобработки данных.

- `preprocess_data(df)`: Предобработка данных, включая создание индикаторной переменной для пропусков в `CustomerID`, присвоение пропускам индекса 0 при энкодировании и добавление столбца `Amount`.
- `save_label_encodings(label_encoders)`: Сохранение соответствий категориальных переменных в файл с кодировкой utf-8.
- `clean_data(df)`: Очищает данные, выполняя следующие шаги:
  1. Поиск и удаление инвойсов с отрицательными значениями `Quantity`.
  2. Поиск и удаление инвойсов с отрицательными значениями `UnitPrice`.
  3. Вывод и удаление инвойсов, не соответствующих условию "a 6-digit integral number".
  4. Вывод и удаление инвойсов с разными `InvoiceDate` или `CustomerID` для одного `InvoiceNo`.
- `normalize_data(data, feature_range=(0, 1))`: Нормализация данных с использованием `MinMaxScaler`.
- `create_sequences(data, seq_length)`: Создание последовательностей данных для обучения моделей временного ряда.
- `fill_missing_sales(df)`: Заполняет пропущенные дни средним арифметическим продаж за неделю и обрабатывает NaN и бесконечные значения.
- `preprocess_time_series(data, train_size=0.8)`: Обрабатывает временной ряд, выполняет проверку на стационарность, дифференцирование и возвращает обучающие и тестовые выборки.


### `visualization.py`
<sup>[Открыть visualization.py на GitHub](https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/Modules/visualization.py)</sup>

Модуль для визуализации данных.

- `plot_line_chart(data, x, y, title, xlabel, ylabel)`: Строит линейный график с использованием данных.
- `visualize_missing_data(df_date_features)`: Визуализирует пропущенные данные, определяет отсутствующие даты и создает графики для отображения пропусков по неделям и дням недели.
- `plot_heatmap(df_date_features, title, xlabel, ylabel)`: Строит тепловую карту для визуализации суммы продаж по дням недели и месяцам.
- `correlation_matrix(df)`: Создает и визуализирует корреляционную матрицу для числовых переменных в данных.
- `visualize_time_series(ts, title='Временной ряд')`: Визуализирует временной ряд.
- `visualize_predictions(train_data, fitted_values, test_data, forecast, model_name, best_model=None)`: Визуализирует обучающие данные, предсказания и прогнозы временных рядов, а также остатки прогнозов.

## Задачи
1. Взять набор данных исходя из ваших интересов.
2. Не использовать датасеты, которые уже использовались ранее.
3. Описать колонки, указать их характеристики.
4. Провести предварительный анализ данных (EDA).
5. Провести предварительную обработку данных (заполнение пропущенных значений, замена категориальных признаков, выявление и обработка аномалий и т.д.).
6. Решить задачу сегментации или анализа временного ряда, используя не менее 5 подходов машинного обучения. Составить ансамбль моделей.
7. Визуализировать результаты: создать графики ошибок прогнозирования, метрик качества обученных моделей и важности признаков.
8. Разместить результат выполнения проекта в GitHub репозитории.

## Предварительный анализ данных (EDA)
В рамках EDA будет проведен анализ распределений, трендов и сезонных компонентов временного ряда. Также будут выявлены аномалии и исключительные значения, которые могут повлиять на анализ и моделирование.

## Предобработка данных
Для предобработки данных будут выполнены следующие шаги:
- Заполнение пропущенных значений.
- Замена категориальных признаков на числовые значения.
- Выявление и обработка аномалий и исключительных значений.
- Дифференцирование данных для достижения стационарности временного ряда.
- Создание последовательностей данных для обучения моделей временного ряда.
- Нормализация данных с использованием `MinMaxScaler`.

## Моделирование и прогнозирование
Для решения задачи анализа временного ряда будут использованы следующие подходы:
1. Модель ARIMA.
2. Автоматическая модель ARIMA (Auto ARIMA).
3. Модель SARIMA.
4. LSTM модель.
5. GRU модель.
6. CNN модель.
7. AutoML PyCaret

## Визуализация
Будут созданы следующие визуализации:
- Графики ошибок прогнозирования.
- Метрики качества обученных моделей.
- Важность признаков.
- Временные ряды и прогнозы моделей.
- Корреляционные матрицы.
- Тепловые карты.
