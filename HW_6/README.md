# Анализ временного ряда на основе транзакционных данных онлайн-розничной торговли

## Описание проекта
Этот проект посвящен анализу временного ряда на основе транзакционных данных онлайн-розничной торговли. Данные охватывают период с 01/12/2010 по 09/12/2011 и включают все транзакции, произошедшие в этот период для не-магазинного онлайн-розничного продавца, зарегистрированного в Великобритании. Компания в основном продает уникальные подарки для всех случаев. Многие клиенты компании являются оптовиками.

## Датасет
Датасет был взят с сайта [UCI Machine Learning Repository](https://archive.ics.uci.edu/dataset/352/online+retail).

### Описание колонок
| Название колонки | Роль      | Тип         | Описание                                                                                    | Единицы измерения | Пропущенные значения |
|------------------|-----------|-------------|---------------------------------------------------------------------------------------------|-------------------|----------------------|
| `InvoiceNo`      | ID        | Categorical | Номер счета-фактуры. Уникальный шестизначный целый номер, присваиваемый каждой транзакции. Если код начинается с буквы 'c', это означает отмену. | нет               | нет                  |
| `StockCode`      | ID        | Categorical | Код продукта. Уникальный пятизначный целый номер, присваиваемый каждому отдельному продукту. | нет               | нет                  |
| `Description`    | Feature   | Categorical | Наименование продукта.                                                                      | нет               | нет                  |
| `Quantity`       | Feature   | Integer     | Количество каждого продукта (товара) за транзакцию.                                         | нет               | нет                  |
| `InvoiceDate`    | Feature   | Date        | День и время, когда была создана транзакция.                                                | нет               | нет                  |
| `UnitPrice`      | Feature   | Continuous  | Цена продукта за единицу.                                                                   | фунт стерлингов   | нет                  |
| `CustomerID`     | Feature   | Categorical | Уникальный пятизначный целый номер, присваиваемый каждому клиенту.                          | нет               | нет                  |
| `Country`        | Feature   | Categorical | Название страны, где проживает каждый клиент.                                               | нет               | нет                  |

## Структура проекта
Проект имеет следующую структуру:

<pre>
HW_6/
├── Data/
│   └── online+retail.zip
├── Modules/
│   ├── <a href="https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/Modules/data_loader.py">data_loader.py</a>
│   ├── <a href="https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/Modules/eda.py">eda.py</a>
│   ├── <a href="https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/Modules/feature_engineering.py">feature_engineering.py</a>
│   ├── <a href="https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/Modules/modeling.py">modeling.py</a>
│   ├── <a href="https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/Modules/preprocessing.py">preprocessing.py</a>
│   └── <a href="https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/Modules/visualization.py">visualization.py</a>
├── <a href="https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/requirements.txt">requirements.txt</a>
├── <a href="https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/README.md">README.md</a>
└── <a href="https://github.com/Vera-Moroz/DS_Project/blob/main/HW_6/main.ipynb">main.ipynb</a>
</pre>


## Описание модулей

### `data_loader.py`
Модуль для загрузки данных из различных источников.

- `load_data_from_site()`: Загрузка датасета 'Online Retail' из репозитория UCI и сохранение в файл. Возвращает DataFrame с данными.
- `load_data_from_zip()`: Загрузка датасета 'Online Retail' из архива и сохранение в файл. Возвращает DataFrame с данными.
- `data_load()`: Запрос у пользователя о выборе источника данных и загрузка данных.

#### Опциональные файлы, создаваемые в подкаталоге Data

- `label_encodings.txt`: Файл содержит закодированные метки для категориальных переменных. Используется для преобразования категориальных данных в числовые значения.
- `online_retail_csv.csv`: CSV файл, содержащий данные датасета 'Online Retail', извлеченные из Excel файла и сохраненные для ускорения будущих загрузок.
- `online_retail_features.csv`: CSV файл, содержащий признаки (features) данных, загруженных из репозитория UCI.
- `Online Retail.xlsx`: Excel файл, содержащий полный датасет 'Online Retail', извлеченный из zip-архива.

Эти файлы являются опциональными и создаются при выполнении модуля data_loader.py.

### `eda.py`
Модуль для выполнения анализа данных (EDA).

- `perform_eda(df)`: Выполняет анализ данных (EDA) для переданного DataFrame. Включает вывод информации о полях и типах данных, первых строках данных, статистическом срезе данных, проверке пропущенных значений и дополнительном анализе.
- `compare_statistics(df1, df2)`: Сравнение статистических срезов двух DataFrame и вывод краткого заключения.
- `print_comparison_results(df1, df2)`: Печать результатов сравнения статистических срезов двух DataFrame.
- `analyze_missing_values(df)`: Анализ данных с пропущенными значениями и без них, сравнение статистических срезов.
- `analyze_returns(df)`: Анализ доли возвратов в датасете, подсчет количества и суммы возвратов и продаж.

### `feature_engineering.py`
Модуль для создания новых признаков на основе исходных данных.

- `calculate_amount(df)`: Расчитывает столбец 'Amount' как произведение 'Quantity' и 'UnitPrice'.
- `create_invoice_features(df)`: Создает фичи для каждого чека на основе группировки по `InvoiceNo`.
- `create_customer_features(df)`: Создает фичи для каждого абонента на основе группировки по `CustomerID`.
- `create_date_features(df)`: Создает фичи на основе группировки по дате (без времени).
- `normalize_features(df, columns)`: Нормализует указанные фичи в DataFrame.

### `metrics.py`
Модуль для оценки и диагностики моделей временного ряда.

- `adf_test(series)`: Выполняет тест Дики-Фуллера (ADF) для проверки стационарности временного ряда. Возвращает p-value.
- `ljung_box_test(residuals, lags=[10])`: Выполняет тест Льюнга-Бокса для проверки автокорреляции остатков модели. Возвращает результаты теста.
- `calculate_metrics(actual, predicted)`: Вычисляет метрики модели: среднюю абсолютную ошибку (MAE), среднеквадратичную ошибку (MSE), корень из среднеквадратичной ошибки (RMSE) и средний абсолютный процент ошибки (MAPE). Возвращает значения метрик.

### `modeling.py`
Модуль для обучения и прогнозирования моделей временного ряда.

- `arima_model(train_data, test_data)`: Обучает модель ARIMA на тренировочных данных и возвращает прогноз на тестовых данных.
- `sarima_model(train_data, test_data)`: Обучает модель SARIMA на тренировочных данных и возвращает прогноз на тестовых данных.
- `lstm_model(X_train, y_train, X_test, y_test, seq_length=30)`: Обучает LSTM модель на тренировочных данных и возвращает прогноз на тестовых данных.
- `gru_model(X_train, y_train, X_test, y_test, seq_length=30)`: Обучает GRU модель на тренировочных данных и возвращает прогноз на тестовых данных.
- `cnn_model(X_train, y_train, X_test, y_test, seq_length=30)`: Обучает CNN модель на тренировочных данных и возвращает прогноз на тестовых данных.

### `preprocessing.py`
Модуль для предобработки данных.

- `preprocess_data(df)`: Предобработка данных: создание индикаторной переменной для пропусков в `CustomerID`, присвоение пропускам индекса 0 при энкодировании и добавление столбца `Amount`.
- `save_label_encodings(label_encoders)`: Сохранение соответствий категориальных переменных в файл с кодировкой utf-8.
- `clean_data(df)`: Очищает данные, выполняя следующие шаги:
  1. Поиск и удаление инвойсов с отрицательными значениями `Quantity`.
  2. Поиск и удаление инвойсов с отрицательными значениями `UnitPrice`.
  3. Вывод и удаление инвойсов, не соответствующих условию "a 6-digit integral number".
  4. Вывод и удаление инвойсов с разными `InvoiceDate` или `CustomerID` для одного `InvoiceNo`.
- `normalize_data(data)`: Нормализация данных с использованием `MinMaxScaler`.
- `create_sequences(data, seq_length)`: Создание последовательностей данных для обучения моделей временного ряда.

### `visualization.py`
Модуль для визуализации данных.

- `plot_line_chart(data, x, y, title, xlabel, ylabel)`: Построение линейного графика для заданных данных.
- `visualize_missing_data(df_date_features)`: Визуализация пропущенных данных по датам.
- `plot_heatmap(df_date_features, title, xlabel, ylabel)`: Построение тепловой карты на основе данных.
- `correlation_matrix(df)`: Построение корреляционной матрицы для числовых данных.
- `visualize_time_series(ts, title='Временной ряд')`: Визуализация временного ряда.
- `visualize_residuals(residuals, title='Остатки модели')`: Визуализация остатков модели.
- `visualize_forecast(train_data, test_data, forecast, title='Прогноз временного ряда')`: Визуализация обучающих данных, тестовых данных и прогноза.
- `visualize_residuals_test(residuals, title='Остатки на тестовой выборке')`: Визуализация остатков на тестовой выборке.

## Задачи
1. Взять набор данных исходя из ваших интересов.
2. Не использовать датасеты, которые вы уже брали.
3. Описать колонки, какие характеристики.
4. Провести анализ EDA.
5. Провести предварительную обработку данных, если это необходимо (сделать данные понятными для модели машинного обучения: заполнить пропущенные значения, заменить категориальные признаки и т.д.).
6. Решить задачу сегментации или анализа временного ряда при помощи не менее 5-ти подходов машинного обучения. Составить ансамбль моделей.
7. Решить задачу поиска аномалий.
8. Визуализация. Создать графики ошибок прогнозирования, метрик качества обученной модели и важности признаков.
9. Разместить результат выполнения финальной работы в GitHub репозитории.

## Предварительный анализ данных (EDA)
В рамках EDA будет проведен анализ распределений, трендов и сезонных компонентов временного ряда. Также будут выявлены аномалии и исключительные значения, которые могут повлиять на анализ и моделирование.

## Предобработка данных
Для предобработки данных будут выполнены следующие шаги:
- Заполнение пропущенных значений.
- Замена категориальных признаков на числовые значения.
- Выявление и обработка аномалий и исключительных значений.
- Дифференцирование данных для достижения стационарности временного ряда.

## Моделирование и прогнозирование
Для решения задачи анализа временного ряда будут использованы следующие подходы:
1. Модель ARIMA.
2. Модель SARIMA.
3. LSTM модель.
4. GRU модель.
5. CNN модель.

## Поиск аномалий
Будет проведен анализ и выявление аномалий в данных с использованием методов машинного обучения и статистических методов.

## Визуализация
Будут созданы графики для визуализации ошибок прогнозирования, метрик качества обученной модели и важности признаков.